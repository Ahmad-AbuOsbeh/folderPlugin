<!DOCTYPE html>
<html>
<head lang="en">
    <script src="../../../scripts/buildfire.js"></script>
    <script src="../../../scripts/buildfire/components/carouselLight/carouselLight.js"></script>
    <script src="../../../scripts/buildfire/components/pluginInstance/sortableList.js"></script>
</head>
<body>
<div id="carousel" class="sliderCarousel"></div>
<div id="txt" class="text-left padded padding-bottom-zero clearfix folder-plugin-text hide-empty"></div>
<div id="pluginsContainer"></div>
<script>
    var plugins = [];

    function loadData(err, obj) {
        if (err)return;

        var layout = obj.data.design.selectedLayout;

        initStyle(obj, layout);

        var carouselImages = obj.data.content.carouselImages;
        var carouselContainer = document.getElementById("carousel");

        if (layout != 12) {
            /*carousel.init(carouselImages, carouselContainer);
             carousel.start();*/

            var carousel = new buildfire.components.carousel.view({
                selector: carouselContainer,
                items: carouselImages
            });
        }

        document.getElementById("txt").innerHTML = obj.data.content.text;

        var pluginsContainer = document.getElementById("pluginsContainer");
        pluginsContainer.className ="layout" + layout;
        pluginsContainer.innerHTML = '';

        getPlugins(obj, function (result) {
            plugins = result;

            var options = calcImgOptions(layout);

            for (var i = 0; i < plugins.length; i++) {
                var pluginItem = document.createElement('div');
                pluginItem.classList.add("pluginItem");

                var p = plugins[i].data || plugins[i];

                if (layout != 12) {
                    var divImg = document.createElement('div');
                    divImg.classList.add("media-holder");
                    divImg.classList.add("media-holder-icon");
                    divImg.setAttribute('index', i);
                    divImg.onclick = onClick;

                    if (p.iconUrl || p.iconClassName)
                    {
                        if(p.iconUrl)
                        {
                            divImg.classList.add("hasImg");
                            var img =document.createElement('img')
                            img.src = buildfire.imageLib.cropImage(p.iconUrl, options) ;
                            img.alt = "plugin-img";
                            divImg.appendChild(img);
                        }
                        else{
                            divImg.classList.add("hasIcon");
                            var span =document.createElement('span');
                            span.className += " main-icon " +p.iconClassName;
                            divImg.appendChild(span);
                        }
                    }
                    else{
                        divImg.classList.add("noImg");
                        divImg.innerHTML = "<h1>loading</h1>";
                    }

                    pluginItem.appendChild(divImg);
                }
                var divTitle = document.createElement('div');
                divTitle.classList.add("media-holder");
                divTitle.classList.add("media-holder-text");
                divTitle.onclick = onClick;
                divTitle.setAttribute('index', i);

                var paragraph = document.createElement('p');
                paragraph.innerText = p.title;
                divTitle.appendChild(paragraph);

                pluginItem.appendChild(divTitle);

                pluginsContainer.appendChild(pluginItem);
            }
        });
    }

    function getPlugins(obj, callback) {
        var plugins = [];
        if (obj.data.content.loadAllPlugins) {
            var searchOptions = {pageIndex: 0, pageSize: 100};
            buildfire.components.pluginInstance.getAllPlugins(searchOptions, function (err, res) {
                plugins = res.data;
                callback(res.data);
            });
        }
        else {
            if (obj.data._buildfire && obj.data._buildfire.plugins &&
                obj.data._buildfire.plugins.result && obj.data._buildfire.plugins.data) {
                plugins = getPluginDetails(obj.data._buildfire.plugins.result, obj.data._buildfire.plugins.data);
            }
            callback(plugins);
        }
    }

    function getPluginDetails(pluginsInfo, pluginIds) {
        var returnPlugins = [];
        var tempPlugin = null;
        for (var id = 0; id < pluginIds.length; id++) {
            for (var i = 0; i < pluginsInfo.length; i++) {
                tempPlugin = {};
                var obj = pluginsInfo[i].data ? pluginsInfo[i].data : pluginsInfo[i];
                if (pluginIds[id] == obj.instanceId) {
                    tempPlugin.instanceId = obj.instanceId;
                    if (obj) {
                        tempPlugin.iconUrl = obj.iconUrl;
                        tempPlugin.iconClassName = obj.iconClassName;
                        tempPlugin.title = obj.title;
                        if (obj.pluginType) {
                            tempPlugin.pluginTypeId = obj.pluginType.token;
                            tempPlugin.folderName = obj.pluginType.folderName;
                        }
                        else {
                            tempPlugin.pluginTypeId = obj.pluginTypeId;
                            tempPlugin.folderName = obj.folderName;
                        }
                    } else {
                        tempPlugin.iconUrl = "";
                        tempPlugin.title = "[No title]";
                    }
                    returnPlugins.push(tempPlugin);
                }
                tempPlugin = null;
            }
        }
        return returnPlugins;
    }

    function initStyle(obj, layout) {
        var style = document.getElementById("injectedStyle");
        if (style) document.head.removeChild(style);

        style = document.createElement('style');
        style.id = "injectedStyle";


        if (obj.data.design.backgroundImage) {

            style.innerHTML += "body { background: no-repeat url('" + buildfire.imageLib.cropImage(obj.data.design.backgroundImage, {
                    width: window.innerWidth,
                    height: window.innerHeight
                }) + "') !Important } ";


        }

        if (obj.data.design.hideText)
            style.innerHTML += " .divTitle { display:none !Important} ";

        if (layout == 12) {
            style.innerHTML += " #carousel { display:none !Important} ";
        }

        if (style.innerHTML.length > 0)
            document.head.appendChild(style);
    }

    buildfire.datastore.getWithDynamicData(loadData);
    buildfire.datastore.onUpdate(function (obj) {
        loadData(null, obj)
    });

    function calcImgOptions(layout) {
        var option = {};
        if ([3, 4, 9].indexOf(layout) >= 0) {
            option.width = window.innerWidth;
            option.height = option.width * 9 / 16;
        }
        else if ([1, 8].indexOf(layout) >= 0) {
            option.width = 50;
            option.height = 50;
        }
        else if (layout == 2) {
            option.width = 100;
            option.height = 60;
        }
        else if ([5, 11].indexOf(layout) >= 0) {
            option.width = Math.round(window.innerWidth / 2);
            option.height = option.width;
        }
        else if (layout == 6) {
            option.width = Math.round(window.innerWidth / 2.1);
            option.height = option.width;
        }
        else if (layout == 7) {
            option.width = window.innerWidth;
            option.height = Math.round(window.innerWidth / 2.2);
        }
        else if (layout == 10) {
            option.width = window.innerWidth;
            option.height = Math.round(window.innerWidth * 0.23);
        }
        return option;
    }

    function onClick(e) {

        var i = parseInt(this.getAttribute('index'));
        var p = plugins[i];

        buildfire.navigation.navigateTo({
            pluginId: p.pluginTypeId
            , folderName: p.folderName
            , instanceId: p.instanceId
            , title: p.title
        });
    }

</script>
<style>
    #pluginsContainer .pluginItem {
        width:100%;
        display:block;
    }
    /*
                                                                Layout-1
    */
    #pluginsContainer.layout1 .pluginItem {
        display:inline-block;
        border-top: 1px solid rgba(57, 52, 46, 0.25) !important;
    }

    .layout1 .pluginItem .media-holder.media-holder-icon  {
        width: 60px;
        height: 60px;
        line-height: 58px;
        margin: inherit;
        margin-right: 10px;
        border-radius: 4px;
        margin: 5px 10px 5px 5px;
        text-align: center;
        float:left;
    }

    .layout1 .pluginItem .media-holder.media-holder-icon .main-icon  {
        font-size: 44px;
        position: relative;
        top: 8px;
    }

    .layout1 .pluginItem .media-holder.media-holder-text p  {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        position: relative;
        margin-top: 20px !important;
    }

    /*
                                                                Layout-2
    */
    #pluginsContainer.layout2 .pluginItem {
        display:inline-block;
        border-top: 1px solid rgba(57, 52, 46, 0.25) !important;
    }

    .layout2 .pluginItem .media-holder.media-holder-icon  {
        width: 110px;
        height: 60px;
        line-height: 58px;
        margin: inherit;
        margin-right: 10px;
        border-radius: 4px;
        margin: 5px 10px 5px 5px;
        text-align: center;
        float:left;
        overflow: hidden;
    }

    .layout2 .pluginItem .media-holder.media-holder-icon .main-icon  {
        font-size: 44px;
        position: relative;
        top: 8px;
    }

    .layout2 .pluginItem .media-holder.media-holder-text p  {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        position: relative;
        margin-top: 20px !important;
    }

</style>
</body>
</html>